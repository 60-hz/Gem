dnl Process this file with autoconf to produce a configure script.
AC_INIT(../Base/CPPExtern.h)
AC_CONFIG_HEADER(../Base/config.h)
dnl AC_CONFIG_HEADER(config.h)
gemsrc="./.."

VERSION=0.87-cvs
PACKAGE=gem

AC_SUBST(VERSION)
AC_SUBST(PACKAGE)

dnl we should rather search for the GemLibs
GEMLIBS="../../../GemLibs/"
default_search_libs="$GEMLIBS /usr/local /usr/lib"
default_search_heads="/usr/include /usr/local/include $GEMLIBS"


dnl
dnl first comes the user-config stuff
dnl
AC_ARG_ENABLE(x, [  --libdir=DIR{:DIRS}     where to search for non-standard libs (aka GemLibs)])
AC_ARG_ENABLE(x, [                          [DIR=../../../GemLibs:/usr/local:/usr/lib ]])
AC_ARG_ENABLE(x, [  --includedir=DIR{:DIRS} where to search for non-standard headers])
AC_ARG_ENABLE(x, [                          [DIR=/usr/include:/usr/local/include:../../../GemLibs]])
AC_ARG_ENABLE(x, [])
AC_ARG_ENABLE(static, [  --enable-static         static linking (default is: dynamic) ])
AC_ARG_WITH(glut, [  --with-glut             enable GLUT (mainly the teapot)])
AC_ARG_WITH(gltt, [  --with-gltt             enable GL-TrueType rendering (fonts)])
AC_ARG_WITH(mpeg, [  --with-mpeg             enable MPEG-filmIN support])
AC_ARG_WITH(mpeg3, [  --with-mpeg3            enable MPEG3-filmIN support (overrides MPEG-support)])
AC_ARG_WITH(quicktime, [  --with-quicktime        enable quicktime-filmIN support])
AC_ARG_WITH(avi, [  --with-avi        enable AVI-support (might provide MPEG and quicktime)])

dnl of course we need X, so don't let the user disable it
if test "$with_x" = "no"
then
  echo "Gem will not run without X"
  exit 1
fi

dnl there should be a flag for which paths to search the libs in
dnl maybe ab-use "--libdir"
if test "$libdir" != "\${exec_prefix}/lib"
then
  search_libs=`echo $libdir | sed -e 's/:/ /g'`
else
  search_libs=$default_search_libs
fi

dnl there should be a flag for which paths to search the headers in
dnl maybe ab-use "--includedir"
if test "$includedir" != "\${prefix}/include"
then
  search_heads=`echo $includedir | sed -e 's/:/ /g'`
else
  search_heads="$default_search_heads"
fi

echo HEAD: $search_heads
echo LIBS: $search_libs

dnl
dnl now comes the path-stuff
dnl
PDBASE=/lib/pd
DOCBASE=/share/doc
AC_SUBST(PDBASE)
AC_SUBST(DOCBASE)
dnl ac_prefix is /usr/local by default
AC_SUBST(prefix)


dnl check for architecture
dnl ***********************************************************************

AC_CANONICAL_HOST

ttarget=pd_`echo $host_os | sed /.*/s/-.*//`
target=`echo $ttarget | sed -e 's/\[.].*//'`

echo Configuring for Gem.$target
AC_SUBST(target)

dnl Check for make version

AC_SUBST_FILE(build_rules)


echo $ac_n "checking for gnu make""... $ac_c"  1>&6

ac_make_gnu=`make -v | sed /GNU/p`
if test "$ac_make_gnu" != ""; then
  ac_make_gnu="yes";
  build_rules="Config.gnumake"
  echo $ac_t "yes";
else 
  ac_make_gnu="no";
  build_rules="Config.make"
  echo $ac_t "no";
fi

dnl Checks for programs.
dnl ***********************************************************************

AC_PROG_CXX
#case $target in 
#pd_irix*)
#    echo $ac_n "checking for irix C++ compiler""... $ac_c" 1>&6

#    if test "${GXX+set}" = set; then 
#      echo $ac_t yes;
#      echo "adding flags for irix CC compiler";
#      CXXFLAGS="$CXXFLAGS -o32 -mips2 -xansi -woff 3157,3173";
#    else
#      echo $ac_t no;
#    fi;;
#esac

AC_PROG_CC
AC_SUBST(CC)
AC_SUBST(CXX)
AC_PROG_INSTALL
AC_PROG_MAKE_SET
AC_CHECK_PROGS(shell_prog,sh)

AC_PATH_XTRA


dnl Checks for libraries.
dnl ***********************************************************************

dnl 
dnl make the auxiliary libraries GemLibs
dnl 


if test -d $GEMLIBS
then
  . makeauxlibs
fi

source_dirs="$SOURCEDIRS"
AC_SUBST(source_dirs)

LIBTOOL=""
AC_SUBST(LIBTOOL)
arch_ld_flags="-shared"
AC_SUBST(arch_ld_flags)

if test "$x_libraries" != ""; then
LDFLAGS="$LDFLAGS -L$x_libraries";
fi

AC_CHECK_LIB(X11,main)
AC_CHECK_LIB(Xext,main)
AC_CHECK_LIB(Xxf86vm,XF86VidModeGetAllModeLines)
dnl add -shared to the libraries, so X will be shared
LIBS="-Wl,-shared -Wl,-export-dynamic $LIBS"

dnl AC_ARG_ENABLE(static, "   " ,LIBS="/usr/lib/gcc-lib/i486-linux/egcs-2.91.57/libstdc++.a $LIBS")

AC_CHECK_LIB(m,sin)
AC_CHECK_LIB(z,main)

if test "${GXX+set}" != set; then
AC_CHECK_LIB(dl,dlopen)
AC_CHECK_LIB(stdc++,main)
fi

ggstatic="-Wl,-Bstatic"
dnl AC_ARG_WITH(static,"   " ,LIBS="$ggstatic $LIBS")
echo Static:: $enable_static
if test "$enable_static" = "yes"
then
  LIBS="$ggstatic $LIBS"
fi


dnl Check for OpenGL (Original or Mesa)

	AC_CHECK_LIB(GL, glInitNames,,
		AC_CHECK_LIB(MesaGL,glInitNames,,
        	echo "OpenGL is mandatory";exit 1)
		)

dnl Check for GLU (Original or Mesa)
	AC_CHECK_LIB(GLU, gluLookAt, ,
		AC_CHECK_LIB(MesaGLU,gluLookAt,,
		echo "incomplete OpenGL (no GLU)";exit 1)
		)
dnl Check for GLUT (not necessary)

if test "$with_glut" != "no"
then
  AC_FIND_LIB(glut,glutSolidTeapot, $search_libs, $with_glut)
fi

dnl Checking image-libraries
dnl Check for PNG
	AC_FIND_LIB(png, png_set_compression_level, $search_libs, fail)
dnl Check for TIFF
	AC_FIND_LIB(tiff, TIFFOpen, $search_libs, fail)
dnl Check for Jpeg
	AC_FIND_LIB(jpeg, jpeg_read_header, $search_libs, fail)

dnl Checking font-libraries
if test "$with_gltt" != "no"
then
dnl Check for TTF
	AC_FIND_LIB(ttf, TT_FreeType_Version, $search_libs, $with_gltt)
dnl Check for gltt
	AC_FIND_LIB(gltt, open, $search_libs, fail)
fi

dnl Checking for video-libraries
dnl Check for sgi vl library
AC_CHECK_LIB(vl,main,
             SGI_SPECIFIC="pix_videoSGI.o pix_indycam.o")


dnl Check glib (do we need this for png ?)
	AC_CHECK_LIB(glib, main)

dnl Checking the rest
dnl Check for space-orb
	AC_FIND_LIB(orb, orb_init, $search_libs, fail)


dnl video formats (selectable by command-line args)
if test "$with_mpeg3" != "no"
then
  AC_FIND_LIB(mpeg3, mpeg3_check_sig, search_libs, $with_mpeg3)
fi
if test "$with_mpeg" != "no"
then
  if test "$ac_tr_lib" != "HAVE_LIBMPEG3"
  then
    AC_FIND_LIB(mpeg, OpenMPEG, search_libs, $with_mpeg)
  else
    echo skipping check for mpeg because mpeg3 is used
  fi
fi

if test "$with_quicktime" != "no"
then
  AC_FIND_LIB(quicktime, quicktime_check_sig, search_libs, $with_quicktime)
fi

if test "$with_avi" != "no"
then
  AC_FIND_LIB(aviplay, CreateIAviReadFile, search_libs, $with_avi)
fi


dnl Checking for Headers !
dnl there should be a flag for which paths to search
dnl maybe ab-use "--includedir"

dnl look for PD
AC_FIND_HEADER(m_pd.h, $search_heads , fail)

dnl OpenGL
AC_CHECK_HEADERS(GL/gl.h GL/glu.h,,
        	echo "OpenGL is mandatory";exit 1)


dnl glut (if wanted)
AC_CHECK_HEADER(GL/glut.h)

dnl truetype
if test "$with_gltt" != "no"
then 
AC_FIND_HEADER(GLTTFont.h, $search_heads, $with_gltt)
fi

dnl space-orb
AC_FIND_HEADER(orb.h, $search_heads, fail)

dnl video formats
AC_FIND_HEADER(mpeg.h, $search_heads)
AC_FIND_HEADER(libmpeg3.h, $search_heads)
AC_FIND_HEADER(quicktime/quicktime.h, $search_heads)
AC_FIND_HEADER(avifile/avifile.h, $search_heads)



dnl Checks for typedefs, structures, and compiler characteristics.
AC_C_CONST
dnl AC_C_INLINE
AC_TYPE_SIZE_T

dnl Checks for library functions.
AC_FUNC_VPRINTF
AC_CHECK_FUNCS(strdup strstr)


AC_SUBST(SGI_SPECIFIC)

AC_SUBST(arch_ld_flags)
AC_SUBST(LIBS)
AC_SUBST(INCLUDES)

RANLIB=gcc 
AC_SUBST(RANLIB)

CXXFLAGS="-fPIC"
AC_SUBST(CXXFLAGS)

dnl 
dnl We will use the same Makefiles for any subdir .. so build the Makefile.in
dnl 
. makesource

AC_OUTPUT(Makefile  
$gemsrc/Manips/Makefile
$gemsrc/Particles/Makefile
$gemsrc/Base/Makefile
$gemsrc/MarkEx/Makefile 
$gemsrc/Pixes/Makefile 
$gemsrc/Controls/Makefile 
$gemsrc/Nongeos/Makefile 
$gemsrc/Geos/Makefile
$gemsrc/openGL/Makefile
)

